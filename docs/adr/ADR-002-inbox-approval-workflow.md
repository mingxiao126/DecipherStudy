# ADR-002: Inbox Approval Workflow (Pending / Move / Reject)

**Status:** Accepted  
**Date:** 2026-02-24

## 1. Context (背景)

目前应用内的“录题与上传流程”已经支持了客户端与服务端的**先校验、再确认上传**机制。用户上传成功后：
- 物理 JSON 文件默认优先保存在个人独立的用户目录中（例如 `content/<userId>/<fileName>`）。
- 同时在全局管控表 `content/inbox/index.json` 中，登记一条状态为 `pending` 的待处理元信息记录。

但是，直接写入个人库还无法解决**知识流通与质量控制**的问题。我们需要一个处于中间地带的“人工审批步骤（Inbox 待审阅池）”来决定这些暂存数据的最终去向：
1. **提取到个人库**：正式纳入个人的练习图谱中。
2. **发布到共享库**：推送到全校公共题库进行分发共享。
3. **驳回不收录**：不合格或测试数据，终止其流转。

基于教育知识库长期运营的要求，该审批工作流设计必须满足：**强制可审计（留痕）、极低的数据损毁风险（防误删）、强隔离多租户隐私（防越权）**，并且其核心架构必须便于未来能够非常平滑地低成本扩展（如：支持转区流转页面、批量审批、管理员越权监管等）。

## 2. Decision (决策)

为了达成上述强审计和低风险的目标，经过综合对比，我们对 Inbox 审批流做出了以下架构层面的决策和限制：

1. **采用严谨状态机管理审批流**
   - 记录的状态仅限于以下四种：`pending` (待处理) / `moved_to_user` (转个人) / `moved_to_shared` (转共享) / `rejected` (已驳回)。
   - **单向流转法则**：所有流转指令必须且只能针对 `pending` 状态的记录执行。一旦转入其余三种状态，该记录即视为进入**终态**，拒绝对其进行二次流转操作（拦截重复操作，实现接口幂等）。

2. **坚守“不删档”的安全底线**
   - 当前版本的任何审批动作（包括驳回）**绝不执行底层的物理硬删除**（即不会调用 `fs.unlink`）。
   - 我们严格采用状态流转机制。所有记录作为原始凭证被永久保留在索引和用户个人目录中，仅在应用读取层面进行内容隔离。这一决策以极低的存储成本，大幅提升了系统的容错纠正率及原始审计痕迹的留存度。

3. **权限模型：极端限制的“仅原作者本人操作”**
   - `move-to-user` / `move-to-shared` / `reject` / 基于 ID 读取详情 这四大接口，采用无一例外的“认亲”策略。
   - 提取请求所附带的活跃用户凭据（`reqUser`），必须严密对照记录创建者身份（`reqUser === record.userId`）。一旦查出非本人操作，系统直接切断并按 `403 Forbidden` 处理。目前阶段系统谢绝任何“跨用户代持”及内部代发等功能。

4. **强制落库前的物理数据探针**
   - 转移指令 `move-to-user` / `move-to-shared` 下达执行前系统会强制检查关联的底层 JSON 文件是否物理存活且完整可读。
   - 若系统探雷发现源文件已丢失，转移将被紧急制动（流转中止），向客户端原样抛出 `404`，并严格维持原索引 `pending` 的原貌以防在全局库中打入“死链”。

5. **共享落库的科目名称英文映射 (Subject Normalization)**
   - **核心原则**：中文学科名（如“经济学”）**仅限于前端展示和用户输入时使用**。
   - 文件被推送上全局公海库（Shared Library）时，其最终物理目录结构 **绝对禁止** 直接沿用中文标称。
   - 我们引入一层严格校验拦截机制：此时必须读取目标学校域名的权威控制库 `content/shared/<schoolId>/school.json`，将中文目录名强制映射规范为其中定义的合法英文标识 `subjectId`（例如转换为 `economics`）。
   - 如果映射脱靶（字典内无该项），拒绝发布并回退至 `pending`。这是保障所有后端合并型 API 统一视图不出故障的关键。

## 3. Data Model / Storage (数据模型与落点)

我们完全解耦了状态清单和实质内容的存储管理。

1. **总清单（Manifest）：`content/inbox/index.json`**
    - 它作为全部流转中心的状态枢机，是一个扁平表结构。
    - 记录中保存的核心特征点举例：
        - 基础基元：`id` (唯一标识), `fileName` (实体文件名), `type` (习题/抽认卡类型), `subject` (标称领域), `schoolId` (归属院校)。
        - 源流跟踪：`userId` (贡献者身份), `displayName` (卡片界面展示名), `createdAt` (创建时间)。
        - 状态游标：`status` (上述四种状态)。

2. **共享分发区域落点追踪**
    - 经批准推送到共享库时，底层的物理数据将被拷贝、并同部载入全局目录树。
    - 落位路径为 `content/shared/<schoolId>/<subjectId>/<fileName>`，随后它将被全局 `topics.json` 并入分发通道，面向全校激活读权限。

3. **用户原文件的原位留存**
    - 即使文件被拷贝至上述共享区域或是被驳回，原实体 JSON 文件（位于用户专属目录）将继续原封不动留存在 `userId` 沙盒内，作为用户对该源文件的永久产权凭据。

## 4. API Surface (接口面)

当前围绕 Inbox Flow 的五个核心 API 设计：

- `GET /api/inbox`
    - 主仪表盘拉取列表接口。自带活跃验证与 `?user=` 的归属限制过滤器。
- `GET /api/inbox/:id`
    - 安全的记录内容详览接口。若 `?user=` 的持有者被核对与记录的 `userId` 不符，直接被拦截 `403`。
- `POST /api/inbox/:id/move-to-user`
    - 触发个人化收录转移操作。对已终态项调用会报错 `400`。
- `POST /api/inbox/:id/move-to-shared`
    - 提交全局库入编系统，附加了严苛的 `subjectId` `422` 校验字典环节。
- `POST /api/inbox/:id/reject`
    - 打上回绝戳的否决操作（写入 `rejectedAt` 等终点属性）。

**共同约定**：
以上所有动作接口，均需要于查询参数或 Auth 层附带活跃请求者 `?user=` 以便与目标 record 进行 `1:1` 产权锁验证，且必须满足“仅处理 `status === pending`” 的幂等安全原则。

## 5. Consequences (后果 / 取舍)

**优点突破：**
- **强审计留痕**：所有的状态、驳回发起人、发生时间都被落库，出现纠纷或数据去向不明时易于追溯排错。
- **低风险容忍**：“不删物理实体”的只流转底线，避免了因为手滑操作或磁盘抖动带来的文件永久抹消惨案。
- **高确定性的 MVP 底座**：业务概念极简。由于规避了复杂的角色代持，这一流程不仅健壮且非常容易被所有开发人员读懂。
- **良好的向上伸缩性**：一旦状态机跑通，后续不管是加驳回说明还是加上批量圈选勾选框，在后端都不会对目前的四态结构造成动荡。

**妥协与限制：**
- **历史记录线性膨胀**：既然不删，那么随着运营深度推移，Inbox 的 `index.json` 体积将无限延伸。目前尚未部署配套的历史快照及归档下架清理机制（Archive & Cleanup）。
- **完全去中心化的局限**：当前的“作者本人操作模型”虽然维护了产权隐私界限，但同时也导致应用现在不支持真正意义上“编辑统揽式”的跨用户的中央审阅工作。
- **交互与效率断层**：由于这是 MVP 流，暂未挂载 `rejectReason` (驳回说明原因填写框) 的表单交互；也尚未实装对海量积压题目的 “一键批量转移 / Batch Ops”。

## 6. Follow-up / Future Work (后续计划)

针对目前框架做出的取舍，我们将按照下列顺位进行长期演进：

1. **审批驳回补丁**
    - 在现有的 `move-to-user / reject` 之上，补加并结构化录入一个 `rejectReason` 字段，前端支持弹层填写，以辅助对劣质内容进行指导矫正。
2. **Bulk / 批量操作模块**
    - 为控制面板追加表格 Checkbox 全选，并在 API 层面追加 `POST /api/inbox/bulk/...` 提供单次原子化的群组审批转移工作。
3. **基于 Admin 视图的跨用户审核池**
    - 改造 `reqUser === record.userId` 限流边界，使配置为管理权重的特定角色拥有超级只读甚至超级代持（Proxy）执行资格。
4. **生命周期冷启动与 GC 垃圾回收**
    - 制定 Inbox 归档策略，支持剥离时间戳在一个月或一个季度之前的历史完成项，以保障 `index.json` 加载体量上的健康度（或是直接切换到带分页的 DBMS）。
5. **源头 Trace 打点颗粒化**
    - 在现存字段上更深入地增补如打回来源、解析重检结果等更多标签，增强对低信誉分用户的题源审计阻断。
### 5. 统一分配模式 (Unified Allocation Pattern - Phase 11)
- **演进目标**：将原本分散的 `move-to-user` 和 `move-to-shared` 逻辑向上聚合，提供单一的 `/api/inbox/:id/assign` 路由。
- **动态选路**：接口通过 `targetScope` (shared/user) 与 `targetOwner` (schoolId/userId) 动态决定分发路径。
- **强制标准化**：在分配环节强制要求 `targetSubjectId` 必须符合英文小写规范，从 UI 层引导用户完成“中转英”转换。
- **预留扩展**：接口参数 `createSubjectIfMissing` 为未来自动建档留出技术窗口。
