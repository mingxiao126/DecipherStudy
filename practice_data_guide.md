# DecipherStudy 考题数据生成与渲染指南 (AI 专用)

本指南专门输出给 Gemini、ChatGPT 或其他 LLM，指导其在为 `DecipherStudy` 系统生成题库 JSON 时，如何严格遵守大前端格式黑话与底层数学渲染约束，以确保考题能够在系统中实现完美排版而不会引发解析崩溃。

---

## 1. 最小可复制模板 (结构模板)

所有题型（大题 essay，选择 choice，判断 bool）统一共享底层的 `analysis` 框架结构。

**强烈注意（Schema 红线）**：
- `knowledge_points` 和 `source` 两个字段必须放在 JSON **最顶层**（与 `id`, `type` 同级），决不能塞入 `analysis` 内部。
- 逻辑拆解过程统称为 `analysis.decoding` 和 `analysis.steps`，系统**已经废弃** `decode_steps`，严禁使用旧字段。

```json
{
  "id": "q-01",
  "type": "essay",
  "question": "题干的具体内容，可以包含公式 $x^2$ 以及自动列表换行：\\n- 第一点\\n- 第二点",
  "answer": "1. 第一小问的答案; 2. 第二小问的答案.",
  "analysis": {
    "decoding": [
      "题干原句1：解释业务含义",
      "题干原句2：剥离干扰信息"
    ],
    "conditions": [
      {
        "title": "使用的公式或原理模型",
        "content": "$LF = E + U$",
        "description": "对该公式或概念的深度学理拆解。"
      }
    ],
    "traps": [
      {
        "title": "错觉提示或常见坑点",
        "description": "为什么容易算错，学生常犯的分类误区是什么。"
      }
    ],
    "steps": [
      {
        "title": "第一步：求核心指标",
        "content": "具体的逻辑推导或公式计算代入：$\\frac{500}{10} = 50$",
        "tag": "逻辑拆解 / 计算 / 结论"
      }
    ]
  },
  "knowledge_points": [
    "Macroeconomics",
    "Labor Force"
  ],
  "source": "Textbook Chapter 3"
}
```

---

## 2. 文本排版与渲染规则模板（极为关键）

系统底层拥有极其复杂的文本预处理加 KaTeX 数学分层引擎。为了让引擎在不出错的前提下渲染出精美的排版，**必须严格遵守以下六条法则**：

1. **数学与普通文本分离原则**：
   - 必须**仅将**纯数学公式、方程或单一代数变量用 `$ ... $` 包裹（如 `$U-3$`、`$Real~GDP$`）。
   - 不要滥用公式化排版，绝不要把大段纯中文或独立的整数字放进公式块去渲染，请直接写纯文字 `500` 而非 `$500$`。

2. **货币 $ 与数学 $...$ 禁止混用**：
   - 美元符号（表示金钱金额）在前端有着和 LaTeX 界定符 `$` 相同的长相，一不小心就会在同一段落内引发 KaTeX 前后端闭合错位，导致大面积格式雪崩。
   - **规则**：遇到表示金额的美元符号，请写成“数字 + 空格 + \$”的形式（例如 `5,000 $` 或 `金额是 $ 500`）。系统侦测到金额语境的 `$` 后会自动将其转换为安全的 HTML 实体保护起来。绝不要把金额语境的 $ 和纯数学语境的 `$` 连续无防护地塞在同一个句子里！

3. **公式内的纯英文词组必须保留字距 (`\text{...}`)**：
   - 如果遇到如 `Marginally Attached` 这样又长又带空格的词组，必须作为整体代入 LaTeX 公式运算中，**别直接丢在内部**（KaTeX 会把空格全吞掉变成连写的纯斜体字母）。
   - **必须**使用 `\\text{}` 语法包裹它来维持普通字体与字距：例如 `"$\\text{Marginally Attached} \\notin \\text{Labor Force}$"`。

4. **JSON 转义灾难：所有反斜杠必须双面加固 (`\\`)**：
   - 所有的 LaTeX 指令，在输出为 JSON 字符串格式时，必定需要前置双反斜杠 `\\`，例如：`\\frac`、`\\notin`、`\\text`、`\\subset`！
   - 如果只写成单斜杠如 `\notin`，JavaScript 的 JSON 解析器会立刻将 `\n` 吃掉视作真实的回车换行符，导致前端收到的是乱码破损指令并导致渲染大面积报错崩溃。

5. **百分号 (`%`) 抽离原则**：
   - 不要在数学公式的内部 `$ ... $` 直接使用带斜杠的百分号（不用写 `\$9.09\\%\$` 如此丑陋且极易被截断跨行的写法）。
   - 建议**把百分号抽离于公式之外**，让它作为跟在公式后面的普通文本：例如 `"$\\approx 9.09$%"` 或直白的文本 `"占 9.09%"`。

6. **自动多行列表排版**：
   - 若要在详解 `steps` 或题目 `question` 中，输出垂直排列阅读的**无序列表**：请在输出的同一段字符串中直接敲入 `\\n`，并且紧跟 `- `。例如 `"以下是特征：\\n- 特征A\\n- 特征B"`。系统会自动转换为超高颜值的缩进 HTML 列表格式。
   - 若在 `answer` 中涉及多题目，需要按题号垂直排列的**有序列表**：请直接使用半角分号带序号隔开，形如 `"1. 答案甲; 2. 答案乙"`。系统底层拦截到分号会智能将其打断为优雅垂直的多行序列。

---

## 3. 给 Gemini/ChatGPT 的输入提示词咒语 (Prompt)

每次让 AI 生成习题前，请直接复制下述提示词框架投喂给大模型：

```text
你是一个精通经济学/统计学的教研专家。请为我生成一道 [填写知识点/学科] 的高保真习题 JSON 数据。
你的输出必须有且仅有 JSON，不允许附带外围 Markdown 解释代码块以外的文本。

【强制约束与前端黑话规范】
1. JSON Schema：必须包含 id, type, question, answer, analysis 对象。而 knowledge_points 和 source 必须放在 JSON 根级最顶层。
2. analysis 详解内部必须包含 decoding(数组), conditions(对象数组), traps(对象数组) 和 steps(带tag字段的对象数组)。绝对禁止使用全废弃的 decode_steps 字段。
3. 数学公式规则：真正的公式和独立代数量必须被 $ ... $ 紧密包裹。普通中文段落和独立数字（如 500）保持普通字符串形式，不加包裹。
4. 货币 $ 与数学 $...$ 防混用机制：凡代表货币金额的美元号，请保证以“数字 + 金额符号”如 "5,000 $" 的形式独立展示，不要和公式 $ 混合。
5. 百分比规则：写为 "$\approx 9.09$%" 或普通文本 "9.09%"，不要写成 "$9.09\%$ "。
6. 公式长文本保持规则：公式里如果嵌入带空格的长英文必须包裹在 \text{...} 里，如 "$\text{Labor Force} = E + U$"。
7. 双重转义铁律：JSON 内所有起 LaTeX 控制作用的斜杠必须强制写成双反斜杠，例如：\\frac，\\text，\\subset，\\notin。严禁用单反斜杠。
8. 内联序号：如果 answer 或某字段涉及到多结果（1. XXX 2. YYY），请写成由分号隔开的格式，如 "1. X; 2. Y" 系统会自动处理成 HTML 显示列表。同样，想触发自动列表换行请连用 "\n- "。
```

---

## 4. 给 Gemini/ChatGPT 的输入样例库 (Do's and Don'ts)

| 适用场景 | ❌ 错误写法 (会导致局部崩溃或排版极丑) | ✅ 正确写法 (完美适配系统级解析) |
| :--- | :--- | :--- |
| **JSON 反斜杠注入** | `"计算结果是 \frac{1}{2}"` <br>*(单反斜杠在转义态中蒸发)* | `"计算结果是 $\\frac{1}{2}$"` <br>*(双反斜杠安稳抵达后台)* |
| **生僻含换行风险符号**| `"A \notin B"` <br>*(单斜杠让 JS 解析成 \n 回车符加 otin)* | `"$A \\notin B$"` <br>*(严密双斜杠躲过一切文本拦截)* |
| **嵌入式英文词组** | `"$Not in labor force$"` <br>*(KaTeX引擎吞噬所有空格形成连笔斜体)* | `"$\\text{Not in labor force}$"` <br>*(使用文字包裹块保持正常间距)* |
| **百分符号处理** | `"失业率达到 $10\\%$"` <br>*(又难看且经常截断溢出边框)* | `"失业率达到 $\\approx 9.09$%"` <br>或干脆写纯文本 `"10%"` |
| **极度危险：货币 $** | `"他赚了 $5,000, 对应的法定 $U-3$ 是..."` <br>*(KaTeX将第一个与第三个 $ 错位打结包成一团)* | `"他本月入账 5,000 $, 对应的官方 $U-3$ 是..."`<br>*(系统成功触发 HTML 金额安全转移)* |
| **罗列或答案分项** | `"1. AnsA 2. AnsB 3. AnsC"` | `"1. AnsA; 2. AnsB; 3. AnsC"` <br>*(触发系统自动分号换行引擎)* |
| **段落题干罗列** | `"A=5 B=10 C=15"` | `"如下：\\n- A=5\\n- B=10\\n- C=15"` <br>*(利用换行减号生成高颜值原生子列表)* |

---

## 5. 渲染职责与系统执行顺序 (System Pipeline)

对大前端管道有更深认知，明白文本遭遇了什么，从而杜绝“在源头写奇怪排版”。系统的处理呈精密流水线式：

1. **`qa-auditor.js` (安保把控与校验审计层)**
   - **核心职责**：在测试或生成入库的第一道关卡，强制使用 JSON Schema 校验其合规性。它确保 `knowledge_points` 等字段不被瞎嵌套进 `analysis`；确保题型要素完整，严防旧框架遗毒（如拦截并阻断 `decode_steps` 字段提交）。

2. **`uploader.js` (数据库物理载入层)**
   - **核心职责**：承接安全数据，剥离可能的 Terminal 换行符干扰，稳定将静态 JSON 以标准 UTF-8 编码落地为文件和内存库加载体。

3. **`practice.js` / `decoder.js` / `flashcards.js` (渲染引擎三核)**
   - **渲染链条与顺序**：
     1. **XSS 实体保护与金额抢救**：拦截 `<` 与 `>`，并将所有的数字后方悬空的 `$`（货币记号）闪电替换为 `&#36;` ，完美隐身退出 LaTeX 的视线和制裁。
     2. **反转移与残影缝合**：对遗留在文本中的假回车灾难（如被解构成真回车符和 `otin` 的残局，或者 `\\frac` 变成了单 `\frac`）实施暴力拼合修复，还原真实的 LaTeX 字符串 `\\notin` 和 `\\frac` 并用临时占位符保护。
     3. **内联打断与 Markdown 升格**：搜寻如 `1. A; 2. B` 中潜伏的分号，将它们切断弹换成回车符 `\n`。并根据所有切分开的每一行前端特征（如匹配到 `- ` 或 `1. `），直接原地转化为带统一左对齐缩进格式的 HTML `<ul>` / `<ol>` DOM 标签结构。
     4. **KaTeX 最终接手**：走过这层层淬骨之后，全文本极其纯净安全。剩下的带有规整界定符的 `$ ... $` 最后无障碍抵达 KaTeX 解析库，顺理成章化为高保真的数学 SVG 图形阵列。

---

## 6. 附录：近期由于 AI 生成不规范导致的渲染“翻车”大赏（避坑错题本）

以下为系统刚刚拦截并修复过的、AI 极易犯错且破坏力极强的真实高频报错案例。生成脚本必须以此为鉴：

1. **“半身不遂” —— 忘记闭合公式**
   - **错误生成**：`初始失业率 = $\frac{100}{700} \approx 14.29。`
   - **后果**：缺了右侧闭合的 `$`，导致 KaTeX 贪婪地把后面的中文和下一个公式的元素全吞没进当前公式块中，引发整体排版雪崩。
   - **正确做法**：公式闭合必须绝对对称：`$\frac{100}{700} \approx 14.29$`。

2. **“全裸奔跑” —— 裸露宏指令（忘记套公式罩子）**
   - **错误生成**：`预期通胀 \pi_{\text{expected}} = 2\%` 或 `\\ \Delta \text{Real Wage}`
   - **后果**：直接把毫无保护的 LaTeX 控制序列暴露在纯文本串中，前端因为没监测到 `$` 开关而不调取引擎，页面直接吐出极丑的原始斜杠和字母。
   - **正确做法**：哪怕是一个数学变量，也要妥善包裹：`预期通胀 $\pi_{\text{expected}} = 2\%$`。

3. **“盒子内爆” —— `\text{}` 盒子内违法混用数学指令**
   - **错误生成**：`$\text{Not \in LF}$`
   - **后果**：`\text{...}` 仅仅用来锁定“纯净普通英文/中文字符序列”的字间距和直立体，里面**绝对不允许**混接 `\in`、`\neq` 这种控制指令。这会让引擎彻底迷失并抛出醒目的红色字体报错。
   - **正确做法**：既然用文本框，就老老实实写全拼英文：`$\text{Not in LF}$`。

4. **“致命注释” —— 百分号占位错乱**
   - **错误生成**：`初始参与率 = %\frac{700}{1000}`
   - **后果**： `%` 在 LaTeX 中的真实身份是**代码注释符**！毫无转义地将其放在公式或分数体之前，会导致引擎在读取时遭遇断流，后续公式代码全部失效崩解。
   - **正确做法**：百分号最好独立放在公式块外部作为字符：`$\frac{700}{1000} \times 100 = 70$ %`，如果非要进公式，务必确保严谨转义。
